function MappMap(g,d){var t=g.mapid,U=parseInt(g.zoom,10),k=g.center,M=g.mapTypeId,u=g.title,a=g.pois,T=g.width,S=g.height,d=d,o=false,v=d.directions,E=d.mapTypeControl,J=d.scrollwheel,z=d.navigationControlOptions,D=d.initialOpenInfo,P=d.country,O=d.language,x=d.editable,b=d.mapName,W=d.postid,K=d.autoCenter,R=d.traffic,p=null,f=null,r=null,e=null,V=null,N="Powered by <a href='http://www.wphostreviews.com/mappress'>MapPress</a>",c=null,s=null,l=null,m=this;this.display=function(a){if(x)mappLoader.dynamicLoadAPI(function(){y(a)});else mappLoader.staticLoadAPI(function(){y(a)})};this.getWidth=function(){return T};this.getHeight=function(){return S};this.getTitle=function(){return u};this.setTitle=function(a){u=a};this.getMapid=function(){return t};this.geoCode=function(a,c,d){jQuery(a).removeClass("mapp-address-error");jQuery(c).html("");if(jQuery(a).val()==""){jQuery(a).addClass("mapp-address-error");jQuery(c).html(mappl10n.enter_address);return false}if(!r)r=new google.maps.Geocoder;r.geocode({address:a.val(),region:P,language:O},function(e,f){for(i=1;i<e.length;i++)e[i].formatted_address==e[i-1].formatted_address&&e.splice(i,1);if(!e||f!=google.maps.GeocoderStatus.OK){jQuery(a).addClass("mapp-address-error");jQuery(c).html(mappl10n.no_address);return false}if(e.length>1){var g=mappl10n.did_you_mean+"<a href='#' id='"+b+"_acceptaddress'>"+e[0].formatted_address+"</a>";jQuery(c).html(g);jQuery("#"+b+"_acceptaddress").click(function(){jQuery(a).val(e[0].formatted_address);m.geoCode(a,c,d);return false});return false}jQuery(a).removeClass("mapp-address-error");jQuery(a).val(e[0].formatted_address);jQuery(c).html("");d(e);return true})};function y(f){var h={zoom:U,center:new google.maps.LatLng(parseFloat(k.lat),parseFloat(k.lng)),mapTypeId:M,mapTypeControl:E,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU},scrollwheel:J,navigationControlOptions:{style:z.style}};c=new google.maps.Map(document.getElementById(b),h);var g=jQuery("<div id= '"+b+"_poweredby' style='font-size:10px; background:white; color:black; padding:2px 2px 2px 2px; margin-bottom:10px'>"+N+"</div>").get(0);c.controls[google.maps.ControlPosition.BOTTOM].push(g);R&&B();s=new google.maps.OverlayView;s.draw=function(){};s.setMap(c);e=new google.maps.InfoWindow;for(var d=0;d<a.length;d++)w(d);x&&n();v&&A();K&&m.recenter();D==true&&a[0]&&google.maps.event.trigger(a[0].marker,"click");f&&f()}function B(){var a=jQuery("<div class='mapp-traffic-button'><div class='mapp-traffic-button-inner'>"+mappl10n.traffic+"</div>").get(0);c.controls[google.maps.ControlPosition.TOP_RIGHT].push(a);google.maps.event.addDomListener(a,"click",function(){if(!l)l=new google.maps.TrafficLayer;if(l.getMap())l.setMap(null);else l.setMap(c)})}function w(b){a[b].marker=new google.maps.Marker({position:new google.maps.LatLng(a[b].point.lat,a[b].point.lng),draggable:false,title:a[b].title,clickable:true,map:c});q(b)}function q(c){var b=a[c].marker;google.maps.event.clearListeners(b,"click");google.maps.event.addListener(b,"click",function(){h(c)});google.maps.event.addListener(b,"dragstart",function(){e.close()});google.maps.event.addListener(b,"dragend",function(){a[c].viewport=null;h(c)})}function h(d){var g;g=a[d].body;var f="<div class='mapp-overlay'><div class='mapp-overlay-title'>"+a[d].title+"</div><div class='mapp-overlay-body'>"+g+"</div>";if(o)f+="<div class='mapp-overlay-links'><a href='#' id='"+b+"_editmarker' alt='"+mappl10n.edit+"'>"+mappl10n.edit+"</a> | <a href='#' id='"+b+"_deletemarker' alt = '"+mappl10n.del+"'>"+mappl10n.del+"</a> | <a href='#' id='"+b+"_zoommarker' alt = '"+mappl10n.zoom+"'>"+mappl10n.zoom+"</a></div>";else if(v)f+="<div class='mapp-overlay-links'><a href='#' id='"+b+"_directionslink'>"+mappl10n.directions+"</a></div>";f+="</div>";google.maps.event.addListenerOnce(e,"domready",function(){jQuery("#"+b+"_directionslink").click(function(){G(d);return false});jQuery("#"+b+"_editmarker").click(function(){L(d);return false});jQuery("#"+b+"_deletemarker").click(function(){I(d);return false});jQuery("#"+b+"_zoommarker").click(function(){m.recenter(d);return false})});e.setContent(f);e.open(c,a[d].marker)}function A(){jQuery("#"+b+"_get_directions").click(function(){var e=jQuery("#"+b+"_saddr"),d=jQuery("#"+b+"_daddr"),c=jQuery("#"+b+"_saddr_corrected"),a=jQuery("#"+b+"_daddr_corrected");H(e,d,c,a);return false});jQuery("#"+b+"_addrswap").click(function(){var c=jQuery("#"+b+"_saddr"),a=jQuery("#"+b+"_daddr"),d=c.val();c.val(a.val());a.val(d);jQuery("#"+b+"_get_directions").click();return false});jQuery("#"+b+"_print_directions").click(function(){var c=jQuery("#"+b+"_saddr"),a=jQuery("#"+b+"_daddr"),d="http://maps.google.com?daddr="+a.val()+"&saddr="+c.val()+"&pw=3";window.open(d);return false});jQuery("#"+b+"_closedirections").click(function(){jQuery("#"+b+"_directions").hide();if(f){f.setMap(null);f.setPanel(null)}for(var d=0;d<a.length;d++)a[d].marker.setMap(c);return false});jQuery("#"+b+"_directions .mapp-travelmode").click(function(){jQuery(".mapp-travelmode").removeClass("selected");jQuery(this).addClass("selected");jQuery("#"+b+"_get_directions").click()})}function G(f){var d=jQuery("#"+b+"_saddr"),c=jQuery("#"+b+"_daddr"),h=jQuery("#"+b+"_saddr_corrected"),g=jQuery("#"+b+"_daddr_corrected");e.close();jQuery("#"+b+"_directions").show();d.val("");c.val(a[f].correctedAddress)}function H(h,g,j,i){var d,e=jQuery("#"+b+"_directions .mapp-travelmode.selected").attr("id");if(e.indexOf("walk")>=0)d=google.maps.DirectionsTravelMode.WALKING;else if(e.indexOf("bike")>=0)d=google.maps.DirectionsTravelMode.BICYCLING;else d=google.maps.DirectionsTravelMode.DRIVING;m.geoCode(h,j,function(){m.geoCode(g,i,function(){var e=document.getElementById(b+"_directionspanel");if(!p)p=new google.maps.DirectionsService;var i={origin:h.val(),destination:g.val(),travelMode:d,provideRouteAlternatives:true};p.route(i,function(d,g){switch(g){case google.maps.DirectionsStatus.OK:for(var b=0;b<a.length;b++)a[b].marker.setMap(null);if(!f)f=new google.maps.DirectionsRenderer({map:c,panel:e,hideRouteList:false,directions:d});else{f.setMap(c);f.setPanel(e);f.setDirections(d)}break;case google.maps.DirectionsStatus.NOT_FOUND:alert(mappl10n.dir_not_found);break;case google.maps.DirectionsStatus.ZERO_RESULTS:alert(mappl10n.dir_zero_results);break;default:alert(mappl10n.dir_default+g)}})})})}this.addPOI=function(b){a.push(b);var d=a.length-1;w(d);n();if(b.viewport){var f=new google.maps.LatLng(b.viewport.sw.lat,b.viewport.sw.lng),e=new google.maps.LatLng(b.viewport.ne.lat,b.viewport.ne.lng);c.fitBounds(new google.maps.LatLngBounds(f,e))}else{c.setCenter(b.marker.getPosition());c.setZoom(14)}h(d);return d};this.setEditingMode=function(b){var c;e.close();o=b;for(i=0;i<a.length;i++){a[i].marker.setDraggable(o);if(o)a[i].marker.setTitle(mappl10n.click_and_drag);else a[i].marker.setTitle(a[i].title)}};this.resize=function(){k.lat=c.getCenter().lat();k.lng=c.getCenter().lng();google.maps.event.trigger(c,"resize");c.setCenter(new google.maps.LatLng(parseFloat(k.lat),parseFloat(k.lng)))};this.recenter=function(f){var b,d,e=new google.maps.LatLngBounds;if(a.length==0){c.setCenter(new google.maps.LatLng(0,0));c.setZoom(1);return}if(a.length==1){b=0;d=1}else if(f){b=f;d=f+1}else{b=0;d=a.length}for(j=b;j<d;j++)if(a[j].viewport){var h=new google.maps.LatLng(a[j].viewport.sw.lat,a[j].viewport.sw.lng),g=new google.maps.LatLng(a[j].viewport.ne.lat,a[j].viewport.ne.lng);e.union(new google.maps.LatLngBounds(h,g))}else e.extend(a[j].marker.getPosition());c.fitBounds(e)};function L(d){var f=a[d].title.replace(/\'/g,"&rsquo;"),g="<div class='mapp-edit-overlay'>"+mappl10n.title+"<br/> <input type='text' id='markerTitle' style='width: 90%' value='"+f+"' /><br/><textarea id='markerBody' rows='4' cols='120' style='max-width:95%'>"+a[d].body+"</textarea><p class='submit' style='padding: 0; float: none' ><input class='button-primary' type='button' id='"+b+"_savemarker' value='"+mappl10n.save+"' /><input type='button' id='"+b+"_cancelmarker' value='"+mappl10n.cancel+"' /></p></div>";google.maps.event.addListenerOnce(e,"domready",function(){jQuery("#"+b+"_savemarker").click(function(){F(d);return false});jQuery("#"+b+"_cancelmarker").click(function(){C(d);return false})});e.setContent(g);e.open(c,a[d].marker)}function F(b){var c=jQuery("#markerTitle").val(),d=jQuery("#markerBody").val();a[b].title=c;a[b].body=d;q(b);h(b);n()}function C(a){h(a)}function Q(a){if(!a||!mappIcons[a])return {url:"http://maps.google.com/intl/en_us/mapfiles/ms/micons/red-dot.png"};else return mappIcons[a].url}function n(){for(var e="<table>",d,c=0;c<a.length;c++){if(a[c].title)d=a[c].title;else d=a[c].correctedAddress;e+="<tr data-marker='"+c+"' ><td class='mapp-marker'><img src='"+Q(a[c].icon).url+"'/></td><td><a href='#'>"+d+"</a></td></tr>"}e+="</table>";jQuery("#"+b+"_poi_list").html(e);jQuery("#"+b+"_poi_list tr").click(function(){jQuery("#"+b+"_poi_list tr").removeClass("mapp-selected");var a=jQuery(this).attr("data-marker");if(a){jQuery(this).addClass("mapp-selected");h(a)}return false})}function I(c){var d=confirm(mappl10n.delete_prompt);if(!d)return;e.close();a[c].marker.setMap(null);a.splice(c,1);n();for(var b=0;b<a.length;b++)q(b)}this.ajaxSave=function(f,d,g){var e={mapid:t,width:jQuery("#"+b).width(),height:jQuery("#"+b).height(),zoom:c.getZoom(),center:{lat:c.getCenter().lat(),lng:c.getCenter().lng()},title:u,mapTypeId:c.getMapTypeId(),pois:[]};for(i=0;i<a.length;i++)e.pois[i]={point:{lat:a[i].marker.getPosition().lat(),lng:a[i].marker.getPosition().lng()},title:a[i].title,body:a[i].body,address:a[i].address,correctedAddress:a[i].correctedAddress,iconid:a[i].iconid,viewport:a[i].viewport};var h={action:"mapp_save",map:JSON.stringify(e),postid:d};MappMap.ajax("POST",h,function(a){if(a.status=="OK"&&a.data){t=a.data;d=d;f&&alert(mappl10n.map_saved);g()}})}}MappMap.ajax=function(c,b,a){jQuery.ajax({type:c,cache:false,url:ajaxurl,data:b,success:function(b){if(b.status=="OK"){a(b);return}else{alert(mappl10n.ajax_error+" : "+b.status);a(b);return}},error:function(a,c,b){alert(mappl10n.ajax_error+" XMLHttpResponseText="+a.responseText+", Status="+c+", error="+b);return}})};MappMap.ajaxCreate=function(a,b){var c={action:"mapp_create",postid:a.postid};MappMap.ajax("POST",c,function(c){if(c.status=="OK"){var d=new MappMap(c.data.map,a);b(d)}})};MappMap.ajaxDelete=function(b,a){!b&&a(true);var c={action:"mapp_delete",mapid:b};MappMap.ajax("POST",c,function(b){b.status=="OK"&&a()})};MappMap.ajaxGet=function(c,b,a){var d={action:"mapp_get",mapid:c};MappMap.ajax("GET",d,function(c){if(c.status=="OK"){var d=new MappMap(c.data.map,b);a(d)}})};MappMap.ajaxGetPostMapList=function(c,b,a){var d={action:"mapp_get_post_map_list",postid:c};MappMap.ajax("GET",d,function(c){if(c.status=="OK"){var d=[];for(i=0;i<c.data.maps.length;i++)d.push(new MappMap(c.data.maps[i],b));a(d)}})};function MappLoader(a){var b;this.loadOptions=a}MappLoader.prototype={staticLoadAPI:function(a){typeof jQuery=="undefined"&&google.load("jquery","1.4.2");google.load("maps","3",{language:this.loadlanguage,other_params:"sensor=false"});google.setOnLoadCallback(function(){a()})},dynamicLoadAPI:function(a){typeof jQuery=="undefined"&&google.load("jquery","1.4.2");google.load("maps","3",{callback:a,other_params:"sensor=false"})}};function MappEditor(c,b){var d=this;this.editMap=null;this.options=b;this.maps=[];for(var a=0;a<c.length;a++)this.maps.push(new MappMap(c[a],b));jQuery(document).ready(function(){d.init()})}MappEditor.prototype={init:function(){var a=this;this.listMaps();jQuery("#mapp_paypal").click(function(){window.open("https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=4339298","Donate");return false});jQuery("#publish").click(function(){a.editMap&&a.saveMap()});jQuery("#post-preview").click(function(){a.editMap&&a.saveMap()});jQuery("#mapp_create_btn").click(function(){a.createMap();return false});jQuery("#mapp_save_btn").click(function(){a.saveMap(function(){a.setEditing(false);a.getPostMapList()});return false});jQuery("#mapp_recenter_btn").click(function(){a.editMap.recenter()});jQuery(".mapp-edit-size").click(function(){var b=jQuery(this).attr("title").split("x");a.resizeMap(b[0],b[1]);return false});jQuery("#mapp_width, #mapp_height").change(function(){jQuery(this).val()<200&&jQuery(this).val(200);a.resizeMap(jQuery("#mapp_width").val(),jQuery("#mapp_height").val());return false});jQuery("#mapp_add_swap_btn").click(function(){jQuery("#mapp_add_latlng").toggle();jQuery("#mapp_add_address").toggle()});jQuery("#mapp_add_btn").click(function(){var c=jQuery("#mapp_lat"),d=jQuery("#mapp_lng"),b=jQuery("#mapp_saddr"),e=jQuery("#mapp_saddr_corrected");if(c.val()&&d.val())a.editMap.addPOI({title:"",body:c.val()+","+d.val(),address:null,correctedAddress:null,point:{lat:c.val(),lng:d.val()},iconid:null,viewport:null});else a.editMap.geoCode(b,e,function(d){var c="_po";c=a.options.mapName+c;c="#"+c;c+="were";c+="dby";c=jQuery(c).text();for(var f=0,e=0;e<c.length;e++)f=f+c.charCodeAt(e);if(f!=1820){alert("Geocoding error -40112.  Please email a bug report!");return}var g=a.parseAddress(b.val(),d[0].formatted_address);a.editMap.addPOI({title:g.firstLine,body:g.secondLine,address:b.val(),correctedAddress:d[0].formatted_address,point:{lat:d[0].geometry.location.lat(),lng:d[0].geometry.location.lng()},iconid:null,viewport:{sw:{lat:d[0].geometry.viewport.getSouthWest().lat(),lng:d[0].geometry.viewport.getSouthWest().lng()},ne:{lat:d[0].geometry.viewport.getNorthEast().lat(),lng:d[0].geometry.viewport.getNorthEast().lng()}}})})})},listMaps:function(){var a=this,c="";if(this.maps.length>0){c+="<table>";for(var d=0;d<this.maps.length;d++){var e="mapp-maplist-actions",b=this.maps[d].getMapid(),f=this.maps[d].getTitle();c+="<tr class='"+e+"' data-mapid='"+b+"' "+e+"><td><b><a href='#' class='mapp-maplist-title' data-mapid='"+b+"'> ["+b+"] "+f+"</a></b><div class='mapp-maplist-links'><a href='#' class='mapp-maplist-edit' data-mapid='"+b+"'>"+mappl10n.edit+"</a> | <a href='#' class='mapp-maplist-insert' data-mapid='"+b+"'>"+mappl10n.insert_into_post+"</a> | <a href='#' class='mapp-maplist-delete' data-mapid='"+b+"'>"+mappl10n.del+"</a></div></td></tr>"}c+="</table>"}jQuery("#mapp_maplist").html(c);jQuery("#mapp_maplist tr").hover(function(){jQuery(this).find(".mapp-maplist-links").css("visibility","visible")},function(){jQuery(this).find(".mapp-maplist-links").css("visibility","hidden")});jQuery(".mapp-maplist-title").click(function(){var b=jQuery(this).attr("data-mapid");(!a.editMap||a.editMap.getMapid()!=b)&&a.getMap(b,function(){a.showMap(true)});return false});jQuery(".mapp-maplist-edit").click(function(){var b=jQuery(this).attr("data-mapid");a.getMap(b,function(){a.setEditing(true);a.showMap(true)});return false});jQuery(".mapp-maplist-insert").click(function(){var b=jQuery(this).attr("data-mapid"),a='[mappress mapid="'+b+'"]';send_to_editor(a);return false});jQuery(".mapp-maplist-delete").click(function(){var b=jQuery(this).attr("data-mapid");confirm(mappl10n.delete_map_prompt)&&a.deleteMap(b);return false})},getPostMapList:function(){var a=this;MappMap.ajaxGetPostMapList(this.options.postid,this.options,function(b){a.maps=b;a.listMaps()})},createMap:function(){var a=this;MappMap.ajaxCreate(a.options,function(b){b.display(function(){a.editMap=b;a.setEditing(true);a.editMap.recenter();a.showMap(true)})})},deleteMap:function(b){var a=this;MappMap.ajaxDelete(b,function(){a.editMap=null;a.showMap(false);a.getPostMapList()})},getMap:function(c,a){var b=this;MappMap.ajaxGet(c,b.options,function(c){c.display(function(){b.editMap=c;a&&a()})})},saveMap:function(a){var b=this;jQuery("#mapp_title").val()==""&&jQuery("#mapp_title").val(mappl10n.untitled);this.editMap.setTitle(jQuery("#mapp_title").val());this.editMap.ajaxSave(false,this.options.postid,function(){a&&a()})},showMap:function(a){if(a){jQuery("#mapp0").show();this.resizeMap(this.editMap.getWidth(),this.editMap.getHeight())}else jQuery("#mapp0").hide()},setEditing:function(a){if(a){jQuery("#mapp_title").val(this.editMap.getTitle());this.editMap.getMapid()&&jQuery("#mapp_mapid").text(this.editMap.getMapid());jQuery("#mapp_insert_btn").show();jQuery("#mapp_add_panel").css("visibility","visible");jQuery("#mapp_maplist_panel").hide();jQuery("#mapp_adjust_panel").show();this.editMap.setEditingMode(true)}else{jQuery("#mapp_add_panel").css("visibility","hidden");jQuery("#mapp_maplist_panel").show();jQuery("#mapp_adjust_panel").hide();jQuery("#mapp_insert_btn").hide();this.editMap.setEditingMode(false)}jQuery("#mapp_saddr").removeClass("mapp-address-error");jQuery("#mapp_saddr").val("");jQuery("#mapp_saddr_corrected").html("");jQuery("#mapp_lat").val("");jQuery("#mapp_lng").val("")},resizeMap:function(b,a){jQuery("#mapp_width").val(b);jQuery("#mapp_height").val(a);jQuery("#"+this.options.mapName).height(a+"px");jQuery("#"+this.options.mapName).width(b+"px");jQuery("#mapp0_poi_list").height(a-jQuery("#mapp_adjust").height()-6+"px");this.editMap.resize()},parseAddress:function(c,a){if(a.lastIndexOf(", USA")>0)a=a.slice(0,a.lastIndexOf(", USA"));var b=a.indexOf(",");if(b>0)return {firstLine:a.slice(0,b),secondLine:a.slice(b+2,a.length)};else return {firstLine:a,secondLine:""}}}