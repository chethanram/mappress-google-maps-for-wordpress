var mapp=window.mapp||{};mapp.Editor=function(n,t){function h(){var t="",n,u;if(r.length>0){for(t+="<ul>",n=0;n<r.length;n++)u=r[n].getTitle(),t+="<li data-idx='"+n+"'><b><a href='#' class='mapp-maplist-title' data-idx='"+n+"'> ["+r[n].getMapid()+"] "+u+"<\/a><\/b><div class='mapp-e-actions'><a href='#' class='mapp-maplist-insert' data-idx='"+n+"'>"+mappl10n.insert_into_post+"<\/a> | <a href='#' class='mapp-maplist-delete' data-idx='"+n+"'>"+mappl10n.del+"<\/a><\/div><\/li>";t+="<\/ul>"}jQuery("#mapp_maplist").html(t),jQuery(".mapp-maplist-title").click(function(){var n=jQuery(this).attr("data-idx");return i=r[n],s(!0),!1}),jQuery(".mapp-maplist-insert").click(function(){var t=jQuery(this).attr("data-idx"),n='[mappress mapid="'+r[t].getMapid()+'"]';return send_to_editor(n),!1}),jQuery(".mapp-maplist-delete").click(function(){var n=jQuery(this).attr("data-idx");return nt(n),!1})}function it(){i=new mapp.Map({width:425,height:350,name:"mapp_edit",title:mappl10n.untitled,pois:[],zoom:1,options:y}),r.push(i),s(!0)}function p(){if(i){i.closeInfoWindow();var n=jQuery.trim(jQuery("#mapp_e_title").val());n=n!=""?n:mappl10n.untitled,i.setTitle(n),i.ajaxSave(function(){s(!1),h()})}}function nt(n){confirm(mappl10n.delete_map_prompt)&&r[n].ajaxDelete(function(){r.splice(n,1),i=null,s(!1),h()})}function s(n){if(n){jQuery("#mapp_e_title").val(i.getTitle());var t=i.getMapid()?i.getMapid():"New";jQuery("#mapp_e_mapid").text(t),jQuery("#mapp_e_maplist").hide(),jQuery("#mapp_e_adjust").show(),jQuery("#mapp_e_edit_map").show(),g(),u(),f&&f.setMap(i.getMap()),google.maps.event.clearListeners(i,"poicontent"),google.maps.event.addListener(i,"poicontent",tt),google.maps.event.clearListeners(i,"poidomready"),google.maps.event.addListener(i,"poidomready",b)}else jQuery("#mapp_e_maplist").show(),jQuery("#mapp_e_adjust").hide(),jQuery("#mapp_e_edit_map").hide();jQuery("#mapp_e_saddr").removeClass("mapp-error"),jQuery("#mapp_e_saddr").val(""),jQuery("#mapp_e_saddr_err").hide(),jQuery("#mapp_e_saddr").focus()}function g(){i.display(),c(i.getWidth(),i.getHeight());var n=i.getMap();google.maps.event.clearListeners(n,"click"),google.maps.event.addListener(n,"click",function(n){jQuery("#mapp_e_latlng").text(n.latLng.toUrlValue())})}function c(n,t){jQuery("#mapp_width").val(n),jQuery("#mapp_height").val(t),jQuery("#mapp_e_poi_list").height(t),i.resize(n,t),i.closeInfoWindow()}function u(){for(var t=i.getPois(),r="<ul>",e,f,n=0;n<t.length;n++)e=t[n].title.replace(/\'/g,"&rsquo;"),f=t[n].getImage("mapp-e-icon"),r+="<li id='"+n+"' class='mapp-e-sortable'>"+f+"<div style='display:inline-block'><a href='#' class='mapp-e-poi-list-title'><b>"+e+"<\/b><\/a><div class='mapp-e-actions'><a href='#' class='mapp-e-poi-list-zoom' data-idx='"+n+"'>"+mappl10n.zoom+"<\/a> | <a href='#' class='mapp-e-poi-list-delete' data-idx='"+n+"'>"+mappl10n.del+"<\/a><\/div><\/div><\/li>";r+="<\/ul>",jQuery("#mapp_e_poi_list").html(r),jQuery("#mapp_e_poi_list ul").sortable({axis:"y",placeholder:"mapp-e-sortable-placeholder",forcePlaceholderSize:!0,delay:200,update:function(){var n=jQuery("#mapp_e_poi_list ul").sortable("toArray");i.sortPois(n),u()}}),jQuery("#mapp_e_poi_list li").click(function(n){var r=jQuery(this).attr("id"),t;return jQuery(n.target).hasClass("mapp-e-poi-list-zoom")?(t=i.getPoi(r),t&&t.zoomIn(),!1):jQuery(n.target).hasClass("mapp-e-poi-list-delete")?(t=i.getPoi(r),t&&d(t),!1):(i.getPoi(r).click(),!1)})}function tt(n,t){var i=jQuery(a).clone(!0),r;jQuery("#mapp_e_poi_title",i).val(n.title),jQuery("#mapp_e_poi_body",i).val(n.body),jQuery("#mapp_e_poi_iconid",i).val(n.iconid),n.isPoly()&&(n.type=="polyline"?jQuery("#mapp_e_poi_polyline_fields",i).show():jQuery("#mapp_e_poi_polyline_fields, #mapp_e_poi_polygon_fields",i).show(),r=n.getColors(),jQuery("#mapp_stroke_color",i).val(r.strokeColor),jQuery("#mapp_stroke_weight",i).val(r.strokeWeight),jQuery("#mapp_stroke_opacity",i).val(parseInt(r.strokeOpacity*100)),jQuery("#mapp_fill_color",i).val(r.fillColor),jQuery("#mapp_fill_opacity",i).val(parseInt(r.fillOpacity*100))),n.type=="kml"&&(jQuery("#mapp_e_poi_kml_fields",i).show(),jQuery("#mapp_e_poi_kml_url",i).val(n.overlay.getUrl())),t.content=i}function b(n){var t={title:n.title,body:n.body,iconid:n.iconid,colors:n.getColors()};jQuery("#mapp_e_poi_title, #mapp_e_poi_body").change(function(){n.title=jQuery("#mapp_e_poi_title").val(),n.body=jQuery("#mapp_e_poi_body").val(),u()}),jQuery("#mapp_e_poi_title").focus(),n.isPoly()?(jQuery("#mapp_stroke_color, #mapp_fill_color, #mapp_stroke_weight, #mapp_stroke_opacity, #mapp_fill_opacity").change(function(){colors={strokeColor:jQuery("#mapp_stroke_color").val(),strokeWeight:parseInt(jQuery("#mapp_stroke_weight").val()),strokeOpacity:jQuery("#mapp_stroke_opacity").val()/100},n.type!="polyline"&&(colors.fillColor=jQuery("#mapp_fill_color").val(),colors.fillOpacity=jQuery("#mapp_fill_opacity").val()/100),n.setColors(colors),o=colors}),jQuery("#mapp_stroke_color, #mapp_fill_color").mappColorpicker({})):n.type!="kml"&&mapp.Icons.iconPicker({back:!0,container:"#mapp_e_poi_icon_picker",image:"#mapp_e_poi_icon",selector:"#mapp_e_poi_iconid",toggle:function(){jQuery("#mapp_e_poi_fields").toggle()},picked:function(t){return l=t,n.iconid=t,n.setIcon(t),u(),!1}}),jQuery("#mapp_e_save_poi").click(function(){return i.closeInfoWindow(),!1}),jQuery("#mapp_e_cancel_poi").click(function(){return n.title=t.title,n.body=t.body,n.iconid=t.iconid,n.setIcon(t.iconid),n.setColors(t.colors),u(),i.closeInfoWindow(),!1})}function w(){var n,t;if(i.closeInfoWindow(),f&&f.setDrawingMode(null),t=jQuery("#mapp_e_saddr").val(),t.substring(0,4)=="http"){n=new mapp.Poi({iconid:"kml",overlay:new google.maps.KmlLayer(t,{suppressInfoWindows:!0}),title:"KML",type:"kml"}),google.maps.event.addListener(n.overlay,"status_changed",function(){var t=n.overlay.getStatus();t=="OK"?(meta=n.overlay.getMetadata(),n.title=meta.name,n.body=meta.description,n.viewport=n.overlay.getDefaultViewport(),u()):mappl10n.ajaxErrors&&alert(mappl10n.kml_error+":"+t)}),i.addPoi(n);return}i.getGeocoder().geocodeField("#mapp_e_saddr","#mapp_e_saddr_err",function(t){if(t){if(t instanceof google.maps.LatLng)n=new mapp.Poi({body:"",iconid:l,overlay:new google.maps.Marker({position:t}),title:t.toUrlValue(4)});else{var r=i.getGeocoder().parseAddress(t.formatted_address);n=new mapp.Poi({address:t.formatted_address,body:r.secondLine,iconid:l,overlay:new google.maps.Marker({position:t.geometry.location}),title:r.firstLine,viewport:t.geometry.viewport})}i.addPoi(n),n.center(!0),u()}})}function k(n){var t;f.setDrawingMode(null);switch(n.type){case"polygon":case"polyline":case"circle":case"rectangle":t=new mapp.Poi({body:"",colors:o,iconid:"poly",overlay:n.overlay,title:mappl10n.shape,type:n.type});break;case"marker":default:t=new mapp.Poi({body:"",iconid:null,overlay:n.overlay,title:n.overlay.getPosition().toUrlValue(4),type:null})}i.addPoi(t),u()}function d(n){return i.closeInfoWindow(),confirm(mappl10n.delete_prompt)?(i.removePoi(n),u(),!0):!1}for(var y=t,r=[],f,l=null,o={fillColor:"#9FC6E7",fillOpacity:.5,strokeColor:"#0000FF",strokeOpacity:1,strokeWeight:2},i,a,v,e=0;e<n.length;e++)n[e].options=y,n[e].name="mapp_edit",v=new mapp.Map(n[e]),r.push(v);a=jQuery("#mapp_e_infobox").detach(),h(),typeof mappl10n.id!="undefined"&&(f=new google.maps.drawing.DrawingManager({circleOptions:o,drawingControlOptions:{drawingModes:[google.maps.drawing.OverlayType.MARKER,google.maps.drawing.OverlayType.POLYGON,google.maps.drawing.OverlayType.POLYLINE,google.maps.drawing.OverlayType.RECTANGLE,google.maps.drawing.OverlayType.CIRCLE]},polygonOptions:o,polylineOptions:o,rectangleOptions:o}),google.maps.event.addListener(f,"overlaycomplete",function(n){k(n)})),jQuery("#mapp_metabox").show(),jQuery("#publish, #post-preview").click(function(){p()}),jQuery("#mapp_e_add_map").click(function(){return it(),!1}),jQuery("#mapp_save_btn").click(function(){return p(),!1}),jQuery("#mapp_e_recenter").click(function(){return i.closeInfoWindow(),i.autoCenter(!0),!1}),jQuery(".mapp-edit-size").click(function(){var n=jQuery(this).attr("title").split("x");return c(n[0],n[1]),!1}),jQuery("#mapp_width, #mapp_height").change(function(){return jQuery(this).val()<200&&jQuery(this).val(200),c(jQuery("#mapp_width").val(),jQuery("#mapp_height").val()),!1}),jQuery("#mapp_e_saddr").keypress(function(n){if(n.which==13)return n.preventDefault(),jQuery("#mapp_e_add_poi").click(),!1}),jQuery("#mapp_e_title").keypress(function(n){if(n.which==13)return n.preventDefault(),jQuery("#mapp_save_btn").click(),!1}),jQuery("#mapp_e_add_poi").click(function(){w()}),jQuery("#mapp_myloc").click(function(){return i.getGeocoder().geolocateField("#mapp_e_saddr","#mapp_e_saddr_err",function(){}),!1})}